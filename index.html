<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian Equity Portfolio Manager</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom CSS -->
    <style>
        .navbar-brand {
            font-weight: bold;
            color: #0d6efd !important;
        }
        .portfolio-card {
            transition: transform 0.2s;
        }
        .portfolio-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .signal-buy {
            background-color: #d1e7dd;
        }
        .signal-sell {
            background-color: #f8d7da;
        }
        .signal-hold {
            background-color: #fff3cd;
        }
        .advisor-section {
            display: none;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Indian Equity Portfolio Manager</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" id="nav-portfolio">Portfolio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="nav-advisor" style="display: none;">Advisor Dashboard</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <button class="btn btn-outline-light me-2" id="btn-login">Login</button>
                    <button class="btn btn-outline-light" id="btn-logout" style="display: none;">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Email address</label>
                            <input type="email" class="form-control" id="loginEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="loginAdvisor">
                            <label class="form-check-label" for="loginAdvisor">Login as Advisor</label>
                        </div>
                        <button type="submit" class="btn btn-primary">Login</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Portfolio Section -->
        <div id="portfolio-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Portfolio Management</h2>
                <button class="btn btn-primary" id="btn-add-stock">Add Stock</button>
            </div>

            <!-- Portfolio Summary -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Total Value</h5>
                            <h3 class="card-text" id="portfolio-total">₹0.00</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Total Gain/Loss</h5>
                            <h3 class="card-text" id="portfolio-gain">₹0.00</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Number of Stocks</h5>
                            <h3 class="card-text" id="portfolio-count">0</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stocks List -->
            <div class="row" id="stocks-container">
                <!-- Stocks will be dynamically added here -->
            </div>
        </div>

        <!-- Advisor Dashboard Section -->
        <div id="advisor-section" class="advisor-section">
            <h2 class="mb-4">Advisor Dashboard</h2>
            
            <!-- Performance Charts -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Portfolio Performance</div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="performanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Sector Allocation</div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="sectorChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advisory Signals -->
            <div class="card mb-4">
                <div class="card-header">Advisory Signals</div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Stock</th>
                                <th>Current Price</th>
                                <th>Signal</th>
                                <th>Reason</th>
                                <th>Target Price</th>
                            </tr>
                        </thead>
                        <tbody id="signals-table">
                            <!-- Signals will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Stock Modal -->
    <div class="modal fade" id="addStockModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Stock to Portfolio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addStockForm">
                        <div class="mb-3">
                            <label for="stockSymbol" class="form-label">Stock Symbol</label>
                            <input type="text" class="form-control" id="stockSymbol" required>
                        </div>
                        <div class="mb-3">
                            <label for="stockName" class="form-label">Stock Name</label>
                            <input type="text" class="form-control" id="stockName" required>
                        </div>
                        <div class="mb-3">
                            <label for="stockQuantity" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="stockQuantity" required min="1">
                        </div>
                        <div class="mb-3">
                            <label for="stockPrice" class="form-label">Purchase Price (₹)</label>
                            <input type="number" class="form-control" id="stockPrice" required min="0" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="stockSector" class="form-label">Sector</label>
                            <select class="form-select" id="stockSector" required>
                                <option value="">Select Sector</option>
                                <option value="IT">Information Technology</option>
                                <option value="BANKING">Banking</option>
                                <option value="AUTO">Automobile</option>
                                <option value="PHARMA">Pharmaceuticals</option>
                                <option value="FMCG">FMCG</option>
                                <option value="ENERGY">Energy</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Stock</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Global variables
        let currentUser = null;
        let portfolios = [];
        let advisorySignals = [];

        // DOM Elements
        const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
        const addStockModal = new bootstrap.Modal(document.getElementById('addStockModal'));

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            loadPortfolios();
            setupEventListeners();
        });

        // Event Listeners
        function setupEventListeners() {
            // Login/Logout
            document.getElementById('btn-login').addEventListener('click', () => loginModal.show());
            document.getElementById('btn-logout').addEventListener('click', handleLogout);
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Navigation
            document.getElementById('nav-portfolio').addEventListener('click', showPortfolioSection);
            document.getElementById('nav-advisor').addEventListener('click', showAdvisorSection);
            
            // Portfolio Management
            document.getElementById('btn-add-stock').addEventListener('click', () => addStockModal.show());
            document.getElementById('addStockForm').addEventListener('submit', handleAddStock);
        }

        // Authentication Functions
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const isAdvisor = document.getElementById('loginAdvisor').checked;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password, isAdvisor })
                });

                if (response.ok) {
                    const user = await response.json();
                    currentUser = user;
                    updateUIAfterLogin();
                    loginModal.hide();
                } else {
                    alert('Login failed. Please check your credentials.');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            }
        }

        function handleLogout() {
            currentUser = null;
            document.getElementById('btn-login').style.display = 'block';
            document.getElementById('btn-logout').style.display = 'none';
            document.getElementById('nav-advisor').style.display = 'none';
            document.getElementById('advisor-section').style.display = 'none';
            document.getElementById('portfolio-section').style.display = 'block';
        }

        function updateUIAfterLogin() {
            document.getElementById('btn-login').style.display = 'none';
            document.getElementById('btn-logout').style.display = 'block';
            
            if (currentUser.isAdvisor) {
                document.getElementById('nav-advisor').style.display = 'block';
                loadAdvisorData();
            }
        }

        // Portfolio Functions
        async function loadPortfolios() {
            try {
                const response = await fetch('/api/portfolio');
                if (response.ok) {
                    portfolios = await response.json();
                    renderPortfolios();
                }
            } catch (error) {
                console.error('Error loading portfolios:', error);
                // Load dummy data for MVP
                loadDummyData();
            }
        }

        function loadDummyData() {
            portfolios = [
                {
                    id: 1,
                    symbol: 'RELIANCE',
                    name: 'Reliance Industries',
                    quantity: 10,
                    purchasePrice: 2500,
                    currentPrice: 2800,
                    sector: 'ENERGY'
                },
                {
                    id: 2,
                    symbol: 'INFY',
                    name: 'Infosys',
                    quantity: 15,
                    purchasePrice: 1500,
                    currentPrice: 1650,
                    sector: 'IT'
                },
                {
                    id: 3,
                    symbol: 'HDFCBANK',
                    name: 'HDFC Bank',
                    quantity: 8,
                    purchasePrice: 1600,
                    currentPrice: 1550,
                    sector: 'BANKING'
                }
            ];
            renderPortfolios();
        }

        async function handleAddStock(e) {
            e.preventDefault();
            const symbol = document.getElementById('stockSymbol').value;
            const name = document.getElementById('stockName').value;
            const quantity = parseInt(document.getElementById('stockQuantity').value);
            const price = parseFloat(document.getElementById('stockPrice').value);
            const sector = document.getElementById('stockSector').value;

            const newStock = {
                symbol,
                name,
                quantity,
                purchasePrice: price,
                currentPrice: price, // For MVP, current price same as purchase
                sector
            };

            try {
                const response = await fetch('/api/portfolio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newStock)
                });

                if (response.ok) {
                    portfolios.push(await response.json());
                    renderPortfolios();
                    addStockModal.hide();
                    document.getElementById('addStockForm').reset();
                }
            } catch (error) {
                console.error('Error adding stock:', error);
                // For MVP, add to local array
                newStock.id = Date.now();
                portfolios.push(newStock);
                renderPortfolios();
                addStockModal.hide();
                document.getElementById('addStockForm').reset();
            }
        }

        function renderPortfolios() {
            const container = document.getElementById('stocks-container');
            container.innerHTML = '';

            let totalValue = 0;
            let totalGain = 0;

            portfolios.forEach(stock => {
                const gain = (stock.currentPrice - stock.purchasePrice) * stock.quantity;
                totalValue += stock.currentPrice * stock.quantity;
                totalGain += gain;

                const card = document.createElement('div');
                card.className = 'col-md-4 mb-3';
                card.innerHTML = `
                    <div class="card portfolio-card">
                        <div class="card-body">
                            <h5 class="card-title">${stock.name} (${stock.symbol})</h5>
                            <p class="card-text">
                                Quantity: ${stock.quantity}<br>
                                Purchase Price: ₹${stock.purchasePrice.toFixed(2)}<br>
                                Current Price: ₹${stock.currentPrice.toFixed(2)}<br>
                                Sector: ${stock.sector}
                            </p>
                            <p class="card-text ${gain >= 0 ? 'text-success' : 'text-danger'}">
                                P&L: ₹${gain.toFixed(2)}
                            </p>
                            <button class="btn btn-sm btn-danger" onclick="deleteStock(${stock.id})">Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            // Update summary
            document.getElementById('portfolio-total').textContent = `₹${totalValue.toFixed(2)}`;
            document.getElementById('portfolio-gain').textContent = `₹${totalGain.toFixed(2)}`;
            document.getElementById('portfolio-count').textContent = portfolios.length;
        }

        async function deleteStock(id) {
            try {
                const response = await fetch(`/api/portfolio/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    portfolios = portfolios.filter(stock => stock.id !== id);
                    renderPortfolios();
                }
            } catch (error) {
                console.error('Error deleting stock:', error);
                // For MVP, remove from local array
                portfolios = portfolios.filter(stock => stock.id !== id);
                renderPortfolios();
            }
        }

        // Advisor Functions
        function showAdvisorSection() {
            document.getElementById('portfolio-section').style.display = 'none';
            document.getElementById('advisor-section').style.display = 'block';
            loadAdvisorData();
        }

        function showPortfolioSection() {
            document.getElementById('advisor-section').style.display = 'none';
            document.getElementById('portfolio-section').style.display = 'block';
        }

        async function loadAdvisorData() {
            try {
                // Load advisory signals
                const signalsResponse = await fetch('/api/advisory-signals');
                if (signalsResponse.ok) {
                    advisorySignals = await signalsResponse.json();
                    renderAdvisorySignals();
                }

                // Load charts data
                await loadChartsData();
            } catch (error) {
                console.error('Error loading advisor data:', error);
                // Load dummy data for MVP
                loadDummyAdvisorData();
            }
        }

        function loadDummyAdvisorData() {
            // Dummy advisory signals
            advisorySignals = [
                {
                    symbol: 'RELIANCE',
                    name: 'Reliance Industries',
                    currentPrice: 