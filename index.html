<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Advisor - Indian Equity Markets</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom CSS -->
    <style>
        .portfolio-card {
            transition: transform 0.2s;
        }
        .portfolio-card:hover {
            transform: translateY(-5px);
        }
        .signal-buy {
            color: #28a745;
            font-weight: bold;
        }
        .signal-hold {
            color: #ffc107;
            font-weight: bold;
        }
        .signal-sell {
            color: #dc3545;
            font-weight: bold;
        }
        .advisor-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">Portfolio Advisor</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="loginBtn">Login</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutBtn" style="display: none;">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Login Modal -->
        <div class="modal fade" id="loginModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Advisor Login</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="password" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Login</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Dashboard -->
        <div class="row" id="portfolioDashboard">
            <div class="col-md-8">
                <h2>Portfolio Overview</h2>
                <div class="row" id="portfolioList">
                    <!-- Portfolio cards will be dynamically inserted here -->
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Market Overview</h5>
                    </div>
                    <div class="card-body">
                        <div id="marketIndicators">
                            <!-- Market indicators will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advisor Section (Hidden by default) -->
        <div id="advisorSection" style="display: none;">
            <div class="advisor-section">
                <h3>Advisor Dashboard</h3>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Portfolio Performance</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="performanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Sector Allocation</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="sectorChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5>Advisory Signals</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Stock</th>
                                            <th>Current Price</th>
                                            <th>Technical Signal</th>
                                            <th>Sector Signal</th>
                                            <th>Sentiment Signal</th>
                                            <th>Overall Signal</th>
                                        </tr>
                                    </thead>
                                    <tbody id="signalsTable">
                                        <!-- Signals will be dynamically inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Global state
        let isAdvisor = false;
        let portfolios = [];
        let marketData = [];

        // DOM Ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
        });

        function initializeApp() {
            loadPortfolios();
            loadMarketData();
            checkAuthStatus();
        }

        function setupEventListeners() {
            document.getElementById('loginBtn').addEventListener('click', showLoginModal);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        }

        function showLoginModal(e) {
            e.preventDefault();
            const modal = new bootstrap.Modal(document.getElementById('loginModal'));
            modal.show();
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('userRole', data.role);
                    isAdvisor = data.role === 'advisor';
                    updateUIForAuth();
                    bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
                } else {
                    alert('Login failed. Please check your credentials.');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            }
        }

        function handleLogout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userRole');
            isAdvisor = false;
            updateUIForAuth();
        }

        function checkAuthStatus() {
            const token = localStorage.getItem('authToken');
            const role = localStorage.getItem('userRole');
            if (token && role) {
                isAdvisor = role === 'advisor';
                updateUIForAuth();
            }
        }

        function updateUIForAuth() {
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const advisorSection = document.getElementById('advisorSection');

            if (isAdvisor) {
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                advisorSection.style.display = 'block';
                loadAdvisorData();
            } else {
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
                advisorSection.style.display = 'none';
            }
        }

        async function loadPortfolios() {
            try {
                const response = await fetch('/api/portfolios');
                if (response.ok) {
                    portfolios = await response.json();
                    renderPortfolios();
                } else {
                    // Fallback to dummy data if API fails
                    loadDummyPortfolios();
                }
            } catch (error) {
                console.error('Error loading portfolios:', error);
                loadDummyPortfolios();
            }
        }

        async function loadMarketData() {
            try {
                const response = await fetch('/api/market/data');
                if (response.ok) {
                    marketData = await response.json();
                    renderMarketIndicators();
                } else {
                    loadDummyMarketData();
                }
            } catch (error) {
                console.error('Error loading market data:', error);
                loadDummyMarketData();
            }
        }

        async function loadAdvisorData() {
            if (!isAdvisor) return;

            try {
                const token = localStorage.getItem('authToken');
                const [signalsResponse, chartsResponse] = await Promise.all([
                    fetch('/api/advisory/signals', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }),
                    fetch('/api/advisory/charts', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                ]);

                if (signalsResponse.ok && chartsResponse.ok) {
                    const signals = await signalsResponse.json();
                    const chartsData = await chartsResponse.json();
                    renderAdvisorySignals(signals);
                    renderCharts(chartsData);
                }
            } catch (error) {
                console.error('Error loading advisor data:', error);
            }
        }

        function renderPortfolios() {
            const portfolioList = document.getElementById('portfolioList');
            portfolioList.innerHTML = '';

            portfolios.forEach(portfolio => {
                const card = `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card portfolio-card">
                            <div class="card-body">
                                <h5 class="card-title">${portfolio.name}</h5>
                                <p class="card-text">Value: ₹${portfolio.currentValue.toLocaleString()}</p>
                                <p class="card-text">Return: 
                                    <span class="${portfolio.return >= 0 ? 'text-success' : 'text-danger'}">
                                        ${portfolio.return >= 0 ? '+' : ''}${portfolio.return}%
                                    </span>
                                </p>
                                <p class="card-text">Stocks: ${portfolio.stockCount}</p>
                            </div>
                        </div>
                    </div>
                `;
                portfolioList.innerHTML += card;
            });
        }

        function renderMarketIndicators() {
            const marketIndicators = document.getElementById('marketIndicators');
            marketIndicators.innerHTML = '';

            marketData.forEach(indicator => {
                const indicatorHtml = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${indicator.name}</span>
                        <span class="${indicator.change >= 0 ? 'text-success' : 'text-danger'}">
                            ${indicator.value} (${indicator.change >= 0 ? '+' : ''}${indicator.change}%)
                        </span>
                    </div>
                `;
                marketIndicators.innerHTML += indicatorHtml;
            });
        }

        function renderAdvisorySignals(signals) {
            const signalsTable = document.getElementById('signalsTable');
            signalsTable.innerHTML = '';

            signals.forEach(signal => {
                const row = `
                    <tr>
                        <td>${signal.stock}</td>
                        <td>₹${signal.currentPrice}</td>
                        <td class="signal-${signal.technical.signal.toLowerCase()}">${signal.technical.signal}</td>
                        <td class="signal-${signal.sector.signal.toLowerCase()}">${signal.sector.signal}</td>
                        <td class="signal-${signal.sentiment.signal.toLowerCase()}">${signal.sentiment.signal}</td>
                        <td class="signal-${signal.overall.signal.toLowerCase()}">
                            <strong>${signal.overall.signal}</strong>
                        </td>
                    </tr>
                `;
                signalsTable.innerHTML += row;
            });
        }

        function renderCharts(chartsData) {
            // Performance Chart
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: chartsData.performance.labels,
                    datasets: [{
                        label: 'Portfolio Value',
                        data: chartsData.performance.data,
                        borderColor: '#007bff',
                        tension: 0.1
                    }]
                }
            });

            // Sector Chart
            const sectorCtx = document.getElementById('sectorChart').getContext('2d');
            new Chart(sectorCtx, {
                type: 'pie',
                data: {
                    labels: chartsData.sectors.labels,
                    datasets: [{
                        data: chartsData.sectors.data,
                        backgroundColor: ['#007bff', '#28a745', '#dc3545', '#ffc107', '#6f42c1']
                    }]
                }
            });
        }

        // Dummy data fallbacks
        function loadDummyPortfolios() {
            portfolios = [
                { id: 1, name: 'Growth Portfolio', currentValue: 1250000, return: 12.5, stockCount: 8 },
                { id: 2, name: 'Dividend Portfolio', currentValue: 850000, return: 8.2, stockCount: 6 },
                { id: 3, name: 'Balanced Portfolio', currentValue: 950000, return: 5.8, stockCount: 10 }
            ];
            renderPortfolios();
        }

        function loadDummyMarketData() {
            marketData = [
                { name: 'Nifty 50', value: 18250.45, change: 1.2 },
                { name: 'Sensex', value: 61500.75, change: 0.8 },
                { name: 'Bank Nifty', value: 42500.30, change: -0.5 }
            ];
            renderMarketIndicators();
        }

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
        });
    </script>
</body>
</html>