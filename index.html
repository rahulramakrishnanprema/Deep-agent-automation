<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Manager - Indian Equity Markets</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js for visual reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .signal-buy {
            color: #28a745;
            font-weight: bold;
        }
        .signal-hold {
            color: #ffc107;
            font-weight: bold;
        }
        .signal-sell {
            color: #dc3545;
            font-weight: bold;
        }
        .advisor-only {
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Portfolio Manager</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">Portfolio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="reportsLink" style="display:none;">Reports</a>
                    </li>
                </ul>
                <div class="navbar-nav">
                    <li class="nav-item">
                        <span class="nav-link" id="userRole">Guest</span>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-light btn-sm" id="loginBtn">Login</button>
                    </li>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Portfolio Overview Section -->
        <div class="row">
            <div class="col-12">
                <h2>Portfolio Overview</h2>
                <div id="portfolioList" class="row">
                    <!-- Portfolio cards will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <!-- Advisory Signals Section -->
        <div class="row mt-4">
            <div class="col-12">
                <h2>Advisory Signals</h2>
                <div id="advisorySignals">
                    <!-- Advisory signals will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <!-- Visual Reports Section (Advisor Only) -->
        <div class="row mt-4 advisor-only" id="reportsSection" style="display:none;">
            <div class="col-12">
                <h2>Analytics Dashboard</h2>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Portfolio Performance</div>
                            <div class="card-body">
                                <canvas id="performanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Sector Allocation</div>
                            <div class="card-body">
                                <canvas id="sectorChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let currentUserRole = 'guest';
        let portfolioData = [];
        let advisoryData = [];

        // DOM Content Loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // Initialize application
        function initializeApp() {
            setupEventListeners();
            checkUserRole();
            loadPortfolioData();
            loadAdvisorySignals();
        }

        // Set up event listeners
        function setupEventListeners() {
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('reportsLink').addEventListener('click', showReports);
        }

        // Check user role and adjust UI accordingly
        function checkUserRole() {
            // In a real app, this would come from authentication
            // For demo purposes, we'll simulate both roles
            const isAdvisor = confirm("Are you an advisor? (Cancel for client view)");
            currentUserRole = isAdvisor ? 'advisor' : 'client';
            document.getElementById('userRole').textContent = isAdvisor ? 'Advisor' : 'Client';
            
            if (isAdvisor) {
                document.getElementById('reportsLink').style.display = 'block';
                document.getElementById('reportsSection').style.display = 'block';
            }
        }

        // Handle login
        function handleLogin() {
            alert("Login functionality would be implemented here. Redirecting to login page.");
            // In a real app, this would redirect to login or show a modal
        }

        // Show reports
        function showReports(e) {
            e.preventDefault();
            document.getElementById('reportsSection').scrollIntoView();
            loadVisualReports();
        }

        // Load portfolio data from backend
        async function loadPortfolioData() {
            try {
                const response = await fetch('/api/portfolio');
                if (!response.ok) throw new Error('Failed to fetch portfolio data');
                
                portfolioData = await response.json();
                displayPortfolioData();
            } catch (error) {
                console.error('Error loading portfolio:', error);
                // Fallback to dummy data
                portfolioData = getDummyPortfolioData();
                displayPortfolioData();
            }
        }

        // Load advisory signals from backend
        async function loadAdvisorySignals() {
            try {
                const response = await fetch('/api/advisory-signals');
                if (!response.ok) throw new Error('Failed to fetch advisory signals');
                
                advisoryData = await response.json();
                displayAdvisorySignals();
            } catch (error) {
                console.error('Error loading advisory signals:', error);
                // Fallback to dummy data
                advisoryData = getDummyAdvisoryData();
                displayAdvisorySignals();
            }
        }

        // Load visual reports (advisor only)
        async function loadVisualReports() {
            if (currentUserRole !== 'advisor') return;
            
            try {
                const response = await fetch('/api/visual-reports');
                if (!response.ok) throw new Error('Failed to fetch visual reports');
                
                const reportData = await response.json();
                renderCharts(reportData);
            } catch (error) {
                console.error('Error loading visual reports:', error);
                // Fallback to dummy data
                const dummyReportData = getDummyReportData();
                renderCharts(dummyReportData);
            }
        }

        // Display portfolio data in UI
        function displayPortfolioData() {
            const portfolioList = document.getElementById('portfolioList');
            portfolioList.innerHTML = '';
            
            portfolioData.forEach(stock => {
                const card = createPortfolioCard(stock);
                portfolioList.appendChild(card);
            });
        }

        // Create portfolio card HTML
        function createPortfolioCard(stock) {
            const col = document.createElement('div');
            col.className = 'col-md-4';
            
            col.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">${stock.name} (${stock.symbol})</h5>
                        <h6 class="card-subtitle mb-2 text-muted">${stock.sector}</h6>
                        <p class="card-text">
                            Quantity: ${stock.quantity}<br>
                            Avg. Price: ₹${stock.avgPrice}<br>
                            Current: ₹${stock.currentPrice}<br>
                            P&L: <span class="${stock.pnl >= 0 ? 'text-success' : 'text-danger'}">₹${stock.pnl}</span>
                        </p>
                    </div>
                </div>
            `;
            
            return col;
        }

        // Display advisory signals in UI
        function displayAdvisorySignals() {
            const signalsContainer = document.getElementById('advisorySignals');
            signalsContainer.innerHTML = '';
            
            advisoryData.forEach(signal => {
                const card = createSignalCard(signal);
                signalsContainer.appendChild(card);
            });
        }

        // Create advisory signal card HTML
        function createSignalCard(signal) {
            const col = document.createElement('div');
            col.className = 'col-md-6';
            
            // Determine signal class
            let signalClass = '';
            if (signal.recommendation === 'Buy') signalClass = 'signal-buy';
            else if (signal.recommendation === 'Hold') signalClass = 'signal-hold';
            else if (signal.recommendation === 'Sell') signalClass = 'signal-sell';
            
            col.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">${signal.name} (${signal.symbol})</h5>
                        <h6 class="card-subtitle mb-2 ${signalClass}">Recommendation: ${signal.recommendation}</h6>
                        <p class="card-text">
                            Historical Performance: ${signal.historicalPerformance}<br>
                            Technical Indicators: ${signal.technicalIndicators}<br>
                            Sector Potential: ${signal.sectorPotential}<br>
                            Market Buzz: ${signal.marketBuzz}
                        </p>
                        <p class="card-text">
                            <small class="text-muted">Last updated: ${signal.lastUpdated}</small>
                        </p>
                    </div>
                </div>
            `;
            
            return col;
        }

        // Render charts for visual reports
        function renderCharts(reportData) {
            // Performance Chart
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: reportData.performance.labels,
                    datasets: [{
                        label: 'Portfolio Value',
                        data: reportData.performance.values,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
            
            // Sector Chart
            const sectorCtx = document.getElementById('sectorChart').getContext('2d');
            new Chart(sectorCtx, {
                type: 'pie',
                data: {
                    labels: reportData.sectors.map(s => s.name),
                    datasets: [{
                        data: reportData.sectors.map(s => s.allocation),
                        backgroundColor: [
                            'rgb(255, 99, 132)',
                            'rgb(54, 162, 235)',
                            'rgb(255, 205, 86)',
                            'rgb(75, 192, 192)',
                            'rgb(153, 102, 255)'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }

        // Dummy data functions (fallback when backend is unavailable)
        function getDummyPortfolioData() {
            return [
                {
                    id: 1,
                    symbol: "RELIANCE",
                    name: "Reliance Industries Ltd.",
                    sector: "Energy",
                    quantity: 50,
                    avgPrice: 2450,
                    currentPrice: 2675,
                    pnl: 11250
                },
                {
                    id: 2,
                    symbol: "HDFCBANK",
                    name: "HDFC Bank Ltd.",
                    sector: "Banking",
                    quantity: 75,
                    avgPrice: 1450,
                    currentPrice: 1520,
                    pnl: 5250
                },
                {
                    id: 3,
                    symbol: "INFY",
                    name: "Infosys Ltd.",
                    sector: "IT",
                    quantity: 100,
                    avgPrice: 1650,
                    currentPrice: 1580,
                    pnl: -7000
                }
            ];
        }

        function getDummyAdvisoryData() {
            return [
                {
                    symbol: "RELIANCE",
                    name: "Reliance Industries Ltd.",
                    recommendation: "Buy",
                    historicalPerformance: "Strong",
                    technicalIndicators: "Bullish",
                    sectorPotential: "High",
                    marketBuzz: "Positive",
                    lastUpdated: "2023-10-15"
                },
                {
                    symbol: "HDFCBANK",
                    name: "HDFC Bank Ltd.",
                    recommendation: "Hold",
                    historicalPerformance: "Stable",
                    technicalIndicators: "Neutral",
                    sectorPotential: "Medium",
                    marketBuzz: "Neutral",
                    lastUpdated: "2023-10-15"
                },
                {
                    symbol: "INFY",
                    name: "Infosys Ltd.",
                    recommendation: "Sell",
                    historicalPerformance: "Weak",
                    technicalIndicators: "Bearish",
                    sectorPotential: "Low",
                    marketBuzz: "Negative",
                    lastUpdated: "2023-10-15"
                }
            ];
        }

        function getDummyReportData() {
            return {
                performance: {
                    labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct"],
                    values: [100000, 105000, 110000, 115000, 120000, 118000, 122000, 125000, 130000, 135000]
                },
                sectors: [
                    { name: "Energy", allocation: 35 },
                    { name: "Banking", allocation: 25 },
                    { name: "IT", allocation: 20 },
                    { name: "Healthcare", allocation: 15 },
                    { name: "Other", allocation: 5 }
                ]
            };
        }
    </script>
</body>
</html>