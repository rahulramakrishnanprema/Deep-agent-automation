<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Portfolio Advisor - Indian Equity Markets</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom CSS -->
    <style>
        .advisor-section {
            background-color: #f8f9fa;
            border-left: 4px solid #0d6efd;
            padding: 20px;
            margin-bottom: 20px;
        }
        .portfolio-card {
            transition: transform 0.2s;
        }
        .portfolio-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .signal-buy {
            color: #198754;
            font-weight: bold;
        }
        .signal-sell {
            color: #dc3545;
            font-weight: bold;
        }
        .signal-hold {
            color: #ffc107;
            font-weight: bold;
        }
        .dashboard-card {
            height: 100%;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-graph-up"></i> Portfolio Advisor
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#portfolio">Portfolio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#advisory">Advisory Signals</a>
                    </li>
                    <li class="nav-item advisor-only">
                        <a class="nav-link" href="#dashboard">Advisor Dashboard</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <button class="btn btn-outline-light me-2" onclick="toggleAdvisorView()">
                        <i class="bi bi-person-gear"></i> Toggle Advisor View
                    </button>
                    <button class="btn btn-light" onclick="refreshData()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Portfolio Section -->
        <section id="portfolio" class="mb-5">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-4">Client Portfolio</h2>
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card portfolio-card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Portfolio Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <h6>Total Value</h6>
                                    <h3 id="portfolio-total">â‚¹0.00</h3>
                                </div>
                                <div class="col-6">
                                    <h6>Today's Change</h6>
                                    <h3 id="portfolio-change" class="text-success">+0.00%</h3>
                                </div>
                            </div>
                            <div class="progress mt-3" style="height: 10px;">
                                <div class="progress-bar bg-success" style="width: 60%;"></div>
                                <div class="progress-bar bg-warning" style="width: 25%;"></div>
                                <div class="progress-bar bg-info" style="width: 15%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card portfolio-card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" onclick="addNewHolding()">
                                    <i class="bi bi-plus-circle"></i> Add New Holding
                                </button>
                                <button class="btn btn-outline-primary" onclick="exportPortfolio()">
                                    <i class="bi bi-download"></i> Export Portfolio
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Current Holdings</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Stock</th>
                                            <th>Quantity</th>
                                            <th>Avg Price</th>
                                            <th>Current Price</th>
                                            <th>Value</th>
                                            <th>Change</th>
                                            <th>Signal</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="holdings-table">
                                        <!-- Holdings will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Advisory Signals Section -->
        <section id="advisory" class="mb-5">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-4">Advisory Signals</h2>
                    <p class="text-muted">Based on historical performance, technical indicators, sector potential, and market buzz</p>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <div class="card mb-4">
                        <div class="card-header bg-warning">
                            <h6 class="mb-0">Top Buy Signals</h6>
                        </div>
                        <div class="card-body">
                            <div id="buy-signals-list">
                                <!-- Buy signals will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card mb-4">
                        <div class="card-header bg-secondary">
                            <h6 class="mb-0">Hold Recommendations</h6>
                        </div>
                        <div class="card-body">
                            <div id="hold-signals-list">
                                <!-- Hold signals will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card mb-4">
                        <div class="card-header bg-danger">
                            <h6 class="mb-0">Sell Recommendations</h6>
                        </div>
                        <div class="card-body">
                            <div id="sell-signals-list">
                                <!-- Sell signals will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Advisor Dashboard Section (Advisor Only) -->
        <section id="dashboard" class="advisor-section mb-5" style="display: none;">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-4">Advisor Dashboard</h2>
                    <p class="text-muted">Comprehensive analytics and reports for portfolio advisors</p>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="card dashboard-card">
                        <div class="card-header bg-dark text-white">
                            <h5 class="mb-0">Portfolio Performance</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="performance-chart" height="250"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card dashboard-card">
                        <div class="card-header bg-dark text-white">
                            <h5 class="mb-0">Sector Allocation</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="sector-chart" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="card dashboard-card">
                        <div class="card-header bg-dark text-white">
                            <h5 class="mb-0">Risk Analysis</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="risk-chart" height="200"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card dashboard-card">
                        <div class="card-header bg-dark text-white">
                            <h5 class="mb-0">Market Sentiment</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="bg-success text-white p-3 rounded">
                                        <h4 id="bullish-percent">42%</h4>
                                        <small>Bullish</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="bg-warning text-dark p-3 rounded">
                                        <h4 id="neutral-percent">33%</h4>
                                        <small>Neutral</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="bg-danger text-white p-3 rounded">
                                        <h4 id="bearish-percent">25%</h4>
                                        <small>Bearish</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Global state
        let isAdvisorView = false;
        let portfolioData = null;
        let advisorySignals = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadPortfolioData();
            loadAdvisorySignals();
            checkAdvisorStatus();
        });

        // Load portfolio data from backend API
        async function loadPortfolioData() {
            try {
                const response = await fetch('/api/portfolio');
                if (!response.ok) {
                    throw new Error('Failed to fetch portfolio data');
                }
                portfolioData = await response.json();
                updatePortfolioUI();
            } catch (error) {
                console.error('Error loading portfolio data:', error);
                // Fallback to dummy data for MVP
                loadDummyPortfolioData();
            }
        }

        // Load advisory signals from backend API
        async function loadAdvisorySignals() {
            try {
                const response = await fetch('/api/advisory/signals');
                if (!response.ok) {
                    throw new Error('Failed to fetch advisory signals');
                }
                advisorySignals = await response.json();
                updateAdvisorySignalsUI();
            } catch (error) {
                console.error('Error loading advisory signals:', error);
                // Fallback to dummy data for MVP
                loadDummyAdvisorySignals();
            }
        }

        // Check advisor status and toggle view accordingly
        async function checkAdvisorStatus() {
            try {
                const response = await fetch('/api/user/role');
                if (response.ok) {
                    const userData = await response.json();
                    isAdvisorView = userData.role === 'advisor';
                    toggleAdvisorViewUI();
                }
            } catch (error) {
                console.error('Error checking user role:', error);
            }
        }

        // Toggle advisor view manually
        function toggleAdvisorView() {
            isAdvisorView = !isAdvisorView;
            toggleAdvisorViewUI();
        }

        // Update UI based on advisor view status
        function toggleAdvisorViewUI() {
            const advisorSections = document.querySelectorAll('.advisor-only, .advisor-section');
            advisorSections.forEach(section => {
                section.style.display = isAdvisorView ? 'block' : 'none';
            });
            
            if (isAdvisorView && portfolioData) {
                initializeAdvisorCharts();
            }
        }

        // Update portfolio UI with current data
        function updatePortfolioUI() {
            if (!portfolioData) return;

            // Update portfolio summary
            document.getElementById('portfolio-total').textContent = `â‚¹${portfolioData.totalValue.toLocaleString()}`;
            document.getElementById('portfolio-change').textContent = 
                `${portfolioData.dailyChange >= 0 ? '+' : ''}${portfolioData.dailyChange.toFixed(2)}%`;
            document.getElementById('portfolio-change').className = 
                portfolioData.dailyChange >= 0 ? 'text-success' : 'text-danger';

            // Update holdings table
            const holdingsTable = document.getElementById('holdings-table');
            holdingsTable.innerHTML = '';
            
            portfolioData.holdings.forEach(holding => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${holding.stockName}</strong><br><small class="text-muted">${holding.symbol}</small></td>
                    <td>${holding.quantity}</td>
                    <td>â‚¹${holding.avgPrice.toFixed(2)}</td>
                    <td>â‚¹${holding.currentPrice.toFixed(2)}</td>
                    <td>â‚¹${holding.currentValue.toLocaleString()}</td>
                    <td class="${holding.change >= 0 ? 'text-success' : 'text-danger'}">
                        ${holding.change >= 0 ? '+' : ''}${holding.change.toFixed(2)}%
                    </td>
                    <td><span class="signal-${holding.signal.toLowerCase()}">${holding.signal}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editHolding('${holding.symbol}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeHolding('${holding.symbol}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                holdingsTable.appendChild(row);
            });
        }

        // Update advisory signals UI
        function updateAdvisorySignalsUI() {
            if (!advisorySignals) return;

            const populateSignalList = (listId, signals, signalType) => {
                const list = document.getElementById(listId);
                list.innerHTML = '';
                
                signals.filter(signal => signal.signal === signalType).forEach(signal => {
                    const item = document.createElement('div');
                    item.className = 'mb-2 p-2 border rounded';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${signal.symbol}</strong> - ${signal.stockName}
                                <br>
                                <small class="text-muted">${signal.reason}</small>
                            </div>
                            <span class="signal-${signalType.toLowerCase()}">${signalType}</span>
                        </div>
                    `;
                    list.appendChild(item);
                });
            };

            populateSignalList('buy-signals-list', advisorySignals, 'BUY');
            populateSignalList('hold-signals-list', advisorySignals, 'HOLD');
            populateSignalList('sell-signals-list', advisorySignals, 'SELL');
        }

        // Initialize advisor dashboard charts
        function initializeAdvisorCharts() {
            // Performance Chart
            const perfCtx = document.getElementById('performance-chart').getContext('2d');
            new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Portfolio Value (â‚¹)',
                        data: [1200000, 1250000, 1180000, 1320000, 1400000, 1450000],
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Sector Allocation Chart
            const sectorCtx = document.getElementById('sector-chart').getContext('2d');
            new Chart(sectorCtx, {
                type: 'doughnut',
                data: {
                    labels: ['IT', 'Banking', 'Pharma', 'Auto', 'FMCG'],
                    datasets: [{
                        data: [35, 25, 15, 12, 13],
                        backgroundColor: [
                            '#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false