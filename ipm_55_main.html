<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian Portfolio Manager - Advisor Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js for visual reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom CSS -->
    <style>
        .sidebar {
            min-height: 100vh;
            background-color: #f8f9fa;
            border-right: 1px solid #dee2e6;
        }
        .dashboard-card {
            transition: transform 0.2s;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .signal-buy {
            background-color: #d4edda;
        }
        .signal-hold {
            background-color: #fff3cd;
        }
        .signal-sell {
            background-color: #f8d7da;
        }
        .sector-high {
            color: #198754;
            font-weight: bold;
        }
        .sector-medium {
            color: #fd7e14;
            font-weight: bold;
        }
        .sector-low {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="#" width="30" height="30" class="d-inline-block align-top" alt="">
                Indian Portfolio Manager
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            Advisor Portal
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" id="logoutBtn">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar py-3">
                <div class="list-group">
                    <a href="#portfolio-section" class="list-group-item list-group-item-action">Portfolio Overview</a>
                    <a href="#advisory-section" class="list-group-item list-group-item-action">Advisory Signals</a>
                    <a href="#technical-section" class="list-group-item list-group-item-action">Technical Analysis</a>
                    <a href="#sector-section" class="list-group-item list-group-item-action">Sector Potential</a>
                    <a href="#market-section" class="list-group-item list-group-item-action">Market Buzz</a>
                    <a href="#reports-section" class="list-group-item list-group-item-action">Visual Reports</a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 py-3">
                <!-- Portfolio Section -->
                <section id="portfolio-section">
                    <h2 class="mb-4">Portfolio Management</h2>
                    <div class="card dashboard-card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Client Portfolios</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-3">
                                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addPortfolioModal">
                                    Add New Portfolio
                                </button>
                                <div class="input-group" style="width: 300px;">
                                    <input type="text" class="form-control" placeholder="Search portfolios..." id="portfolioSearch">
                                    <button class="btn btn-outline-secondary" type="button">Search</button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Client Name</th>
                                            <th>Portfolio Value</th>
                                            <th>Stocks Count</th>
                                            <th>Last Updated</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="portfolioTableBody">
                                        <!-- Portfolio data will be populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Advisory Signals Section -->
                <section id="advisory-section" class="mt-5">
                    <h2 class="mb-4">Advisory Signals</h2>
                    <div class="card dashboard-card mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">Stock Recommendations</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <select class="form-select" id="sectorFilter">
                                            <option value="">All Sectors</option>
                                            <!-- Sector options will be populated dynamically -->
                                        </select>
                                        <button class="btn btn-outline-primary" onclick="filterAdvisorySignals()">Filter</button>
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Stock</th>
                                            <th>Sector</th>
                                            <th>Current Price</th>
                                            <th>Signal</th>
                                            <th>Confidence</th>
                                            <th>Reasoning</th>
                                        </tr>
                                    </thead>
                                    <tbody id="advisoryTableBody">
                                        <!-- Advisory signals will be populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Technical Analysis Section -->
                <section id="technical-section" class="mt-5">
                    <h2 class="mb-4">Technical Indicators</h2>
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card dashboard-card h-100">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="mb-0">Moving Averages</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="movingAveragesChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card dashboard-card h-100">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="mb-0">RSI Indicator</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="rsiChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Sector Analysis Section -->
                <section id="sector-section" class="mt-5">
                    <h2 class="mb-4">Sector Potential Evaluation</h2>
                    <div class="card dashboard-card mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Sector Performance</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <canvas id="sectorPerformanceChart" height="300"></canvas>
                                </div>
                                <div class="col-md-6">
                                    <div class="table-responsive">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Sector</th>
                                                    <th>Growth Score</th>
                                                    <th>Potential</th>
                                                    <th>Top Stocks</th>
                                                </tr>
                                            </thead>
                                            <tbody id="sectorTableBody">
                                                <!-- Sector data will be populated dynamically -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Market Buzz Section -->
                <section id="market-section" class="mt-5">
                    <h2 class="mb-4">Market Buzz & Sentiment</h2>
                    <div class="row">
                        <div class="col-md-4 mb-4">
                            <div class="card dashboard-card h-100">
                                <div class="card-header bg-secondary text-white">
                                    <h5 class="mb-0">Overall Market Sentiment</h5>
                                </div>
                                <div class="card-body text-center">
                                    <h1 id="sentimentScore" class="display-4">Neutral</h1>
                                    <p class="text-muted">Based on recent news and social media</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8 mb-4">
                            <div class="card dashboard-card h-100">
                                <div class="card-header bg-secondary text-white">
                                    <h5 class="mb-0">Top Market News</h5>
                                </div>
                                <div class="card-body">
                                    <div id="newsCarousel" class="carousel slide" data-bs-ride="carousel">
                                        <div class="carousel-inner" id="newsContainer">
                                            <!-- News items will be populated dynamically -->
                                        </div>
                                        <button class="carousel-control-prev" type="button" data-bs-target="#newsCarousel" data-bs-slide="prev">
                                            <span class="carousel-control-prev-icon"></span>
                                        </button>
                                        <button class="carousel-control-next" type="button" data-bs-target="#newsCarousel" data-bs-slide="next">
                                            <span class="carousel-control-next-icon"></span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Visual Reports Section -->
                <section id="reports-section" class="mt-5">
                    <h2 class="mb-4">Visual Reports & Dashboards</h2>
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card dashboard-card h-100">
                                <div class="card-header bg-danger text-white">
                                    <h5 class="mb-0">Portfolio Allocation</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="allocationChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card dashboard-card h-100">
                                <div class="card-header bg-danger text-white">
                                    <h5 class="mb-0">Performance Trends</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="performanceTrendChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Add Portfolio Modal -->
    <div class="modal fade" id="addPortfolioModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Portfolio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="portfolioForm">
                        <div class="mb-3">
                            <label for="clientName" class="form-label">Client Name</label>
                            <input type="text" class="form-control" id="clientName" required>
                        </div>
                        <div class="mb-3">
                            <label for="initialInvestment" class="form-label">Initial Investment (₹)</label>
                            <input type="number" class="form-control" id="initialInvestment" required>
                        </div>
                        <div class="mb-3">
                            <label for="riskProfile" class="form-label">Risk Profile</label>
                            <select class="form-select" id="riskProfile">
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addPortfolio()">Save Portfolio</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JavaScript -->
    <script>
        // Authentication check
        function checkAuth() {
            const token = localStorage.getItem('advisorToken');
            if (!token) {
                window.location.href = 'login.html';
            }
        }

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('advisorToken');
            window.location.href = 'login.html';
        });

        // Load portfolio data
        async function loadPortfolios() {
            try {
                const response = await fetch('/api/portfolios', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('advisorToken')}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch portfolios');
                
                const portfolios = await response.json();
                const tableBody = document.getElementById('portfolioTableBody');
                tableBody.innerHTML = '';
                
                portfolios.forEach(portfolio => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${portfolio.clientName}</td>
                        <td>₹${portfolio.value.toLocaleString()}</td>
                        <td>${portfolio.stockCount}</td>
                        <td>${new Date(portfolio.lastUpdated).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewPortfolio(${portfolio.id})">View</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePortfolio(${portfolio.id})">Delete</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading portfolios:', error);
                alert('Failed to load portfolios');
            }
        }

        // Add new portfolio
        async function addPortfolio() {
            const clientName = document.getElementById('clientName').value;
            const initialInvestment = document.getElementById('initialInvestment').value;
            const riskProfile = document.getElementById('riskProfile').value;
            
            try {
                const response = await fetch('/api/portfolios', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('advisorToken')}`
                    },
                    body: JSON.stringify({
                        clientName,
                        initialInvestment: parseFloat(initialInvestment),
                        riskProfile
                    })
                });
                
                if (!response.ok) throw new Error('Failed to add portfolio');
                
                // Close modal and refresh data
                bootstrap.Modal.getInstance(document.getElementById('addPortfolioModal')).hide();
                loadPortfolios();
                alert('Portfolio added successfully');
            } catch (error) {
                console.error('Error adding portfolio:', error);
                alert('Failed to add portfolio');
            }
        }

        // Load advisory signals
        async function loadAdvisorySignals() {
            try {
                const response = await fetch('/api/advisory-signals', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('advisorToken')}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch advisory signals');
                
                const signals = await response.json();
                const tableBody = document.getElementById('advisoryTableBody');
                const sectorFilter = document.getElementById('sectorFilter');
                
                // Clear existing data
                tableBody.innerHTML = '';
                sectorFilter.innerHTML = '<option value="">All Sectors</option>';
                
                // Get unique sectors for filter
                const sectors = [...new Set(signals.map(signal => signal.sector))];
                sectors.forEach(sector => {
                    sectorFilter.innerHTML += `<option value="${sector}">${sector}</option>`;
                });
                
                // Populate signals table
                signals.forEach(signal => {
                    const row = document.createElement('tr');
                    row.classList.add(`signal-${signal.signal.toLowerCase()}`);
                    
                    row.innerHTML = `
                        <td>${signal.stock}</td>
                        <td>${signal.sector}</td>
                        <td>₹${signal.currentPrice.toLocaleString()}</td>
                        <td><span class="badge bg-${getSignalBadgeColor(signal.signal)}">${signal.signal}</span></td>
                        <td>${signal.confidence}%</td>
                        <td>${signal.reasoning}</td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading advisory signals:', error);
                alert('Failed to load advisory signals');
            }
        }

        // Filter advisory signals by sector
        function filterAd